# PostgreSQL Configuration for SMS Marketing Platform v2.0
# Optimized for high-performance contact management and validation

# =============================================================================
# CONNECTION AND AUTHENTICATION
# =============================================================================

# Connection settings
listen_addresses = '*'
port = 5432
max_connections = 200
superuser_reserved_connections = 3

# Authentication
authentication_timeout = 1min
password_encryption = scram-sha-256

# SSL (disabled for development, enable for production)
ssl = off
#ssl_cert_file = 'server.crt'
#ssl_key_file = 'server.key'

# =============================================================================
# RESOURCE USAGE (MEMORY)
# =============================================================================

# Memory settings optimized for 31.8M contacts
shared_buffers = 256MB                    # 25% of RAM for small systems
effective_cache_size = 1GB                # Estimate of OS cache
work_mem = 8MB                            # Memory for sorts/hashes
maintenance_work_mem = 128MB              # Memory for maintenance operations
max_wal_size = 2GB                        # Maximum WAL size
min_wal_size = 512MB                      # Minimum WAL size

# Shared memory and semaphores
dynamic_shared_memory_type = posix

# =============================================================================
# WRITE AHEAD LOG (WAL)
# =============================================================================

# WAL settings for reliability and performance
wal_level = replica                       # Enable replication
wal_compression = on                      # Compress WAL records
wal_buffers = 16MB                        # WAL buffer size
checkpoint_completion_target = 0.9        # Spread checkpoints
checkpoint_timeout = 15min                # Maximum time between checkpoints
max_wal_senders = 3                       # Number of WAL sender processes

# Archive settings (for backup and replication)
archive_mode = off                        # Enable for production
#archive_command = 'cp %p /var/lib/postgresql/archive/%f'

# =============================================================================
# QUERY TUNING
# =============================================================================

# Cost-based optimizer settings
random_page_cost = 1.1                    # SSD-optimized
effective_io_concurrency = 200            # Number of concurrent I/O operations
seq_page_cost = 1.0                       # Sequential page cost

# Planner settings
default_statistics_target = 100           # Statistics target for ANALYZE
constraint_exclusion = partition          # Enable constraint exclusion

# =============================================================================
# LOGGING
# =============================================================================

# Logging configuration
log_destination = 'stderr'
logging_collector = on
log_directory = 'log'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 100MB
log_truncate_on_rotation = on

# What to log
log_min_messages = info
log_min_error_statement = error
log_min_duration_statement = 1000         # Log queries taking > 1 second
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 10MB                     # Log temp files > 10MB

# Log format
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '
log_statement = 'none'                    # Don't log all statements (performance)

# =============================================================================
# RUNTIME STATISTICS
# =============================================================================

# Statistics collection
track_activities = on
track_counts = on
track_io_timing = on
track_functions = all
stats_temp_directory = 'pg_stat_tmp'

# Query statistics (requires pg_stat_statements extension)
shared_preload_libraries = 'pg_stat_statements'
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.save = on

# =============================================================================
# AUTOVACUUM
# =============================================================================

# Autovacuum settings for high-volume contact table
autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 30s                  # Check every 30 seconds
autovacuum_vacuum_threshold = 50
autovacuum_analyze_threshold = 50
autovacuum_vacuum_scale_factor = 0.1      # Vacuum when 10% of table changes
autovacuum_analyze_scale_factor = 0.05    # Analyze when 5% of table changes
autovacuum_vacuum_cost_delay = 10ms
autovacuum_vacuum_cost_limit = 200

# =============================================================================
# CLIENT CONNECTION DEFAULTS
# =============================================================================

# Locale and formatting
datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'en_US.utf8'
lc_monetary = 'en_US.utf8'
lc_numeric = 'en_US.utf8'
lc_time = 'en_US.utf8'

# Default text search configuration
default_text_search_config = 'pg_catalog.english'

# =============================================================================
# PERFORMANCE OPTIMIZATIONS FOR SMS MARKETING WORKLOAD
# =============================================================================

# Optimize for read-heavy workload with batch inserts
effective_cache_size = 1GB
shared_buffers = 256MB
random_page_cost = 1.1
seq_page_cost = 1.0

# Optimize for contact extraction queries
work_mem = 8MB                            # For sorting large result sets
max_parallel_workers_per_gather = 2       # Parallel query execution
max_parallel_workers = 4
max_worker_processes = 8

# Connection pooling optimization
max_connections = 200
shared_buffers = 256MB

# =============================================================================
# EXTENSIONS AND MODULES
# =============================================================================

# Preload extensions for performance monitoring
shared_preload_libraries = 'pg_stat_statements'

# =============================================================================
# CUSTOM SETTINGS FOR SMS MARKETING PLATFORM
# =============================================================================

# Custom settings for our specific workload
# These can be adjusted based on monitoring and performance testing

# For large batch operations (like IFT updates)
temp_buffers = 32MB
max_prepared_transactions = 100

# For geographic data (LADA, states, municipalities)
# Enable if using PostGIS extension
#shared_preload_libraries = 'pg_stat_statements,postgis'

# For full-text search on contact names/addresses
# Enable if implementing search functionality
#default_text_search_config = 'pg_catalog.spanish'  # For Spanish names

# =============================================================================
# DEVELOPMENT VS PRODUCTION SETTINGS
# =============================================================================

# Development settings (current)
fsync = on                                # Keep on for data safety
synchronous_commit = on                   # Keep on for consistency
full_page_writes = on                     # Keep on for crash safety

# Production settings (uncomment for production)
#fsync = on
#synchronous_commit = on
#full_page_writes = on
#wal_sync_method = fdatasync
#checkpoint_completion_target = 0.9
#wal_buffers = 16MB
#checkpoint_timeout = 15min

# =============================================================================
# MONITORING AND ALERTING
# =============================================================================

# Settings for monitoring tools (Prometheus, Grafana)
log_min_duration_statement = 1000         # Log slow queries
log_checkpoints = on
log_lock_waits = on
log_autovacuum_min_duration = 0           # Log all autovacuum activity

# =============================================================================
# BACKUP AND RECOVERY
# =============================================================================

# Settings for backup and point-in-time recovery
wal_level = replica
archive_mode = off                        # Enable for production backups
max_wal_senders = 3
wal_keep_segments = 32                    # Keep WAL segments for replication

# Hot standby settings (for read replicas)
hot_standby = on
max_standby_archive_delay = 30s
max_standby_streaming_delay = 30s
wal_receiver_status_interval = 10s
hot_standby_feedback = on

# =============================================================================
# NOTES
# =============================================================================

# This configuration is optimized for:
# - 31.8M contact records
# - High-volume read operations (contact extraction)
# - Batch write operations (IFT updates, validation results)
# - Geographic data queries (LADA-based filtering)
# - Concurrent validation operations
#
# Adjust memory settings based on available system resources:
# - shared_buffers: 25% of available RAM
# - effective_cache_size: 75% of available RAM
# - work_mem: Available RAM / max_connections / 4
#
# Monitor performance and adjust settings as needed using:
# - pg_stat_statements for query analysis
# - pg_stat_user_tables for table statistics
# - pg_stat_activity for connection monitoring
